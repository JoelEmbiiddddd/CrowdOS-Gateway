# CrowdOS-gateway

![image-20230409170147853](./image/image-20230409170147853.png)



整个**API网关**设计核心内容分为这么五块；

- `第一块`：是关于通信的协议处理，也是网关最本质的处理内容。这里需要借助 NIO 框架 Netty 处理 HTTP 请求，并进行协议转换泛化调用到 RPC 服务返回数据信息。
- `第二块`：是关于注册中心，这里需要把网关通信系统当做一个算力，每部署一个网关服务，都需要向注册中心注册一个算力。而注册中心还需要接收 RPC 接口的注册，这部分可以是基于 SDK 自动扫描注册也可以是人工介入管理。当 RPC 注册完成后，会被注册中心经过AHP权重计算分配到一组网关算力上进行使用。
- `第三块`：是关于路由服务，每一个注册上来的Netty通信服务，都会与他对应提供的分组网关相关联，例如：wg/(a/b/c)/user/... a/b/c 需要匹配到 Nginx 路由配置上，以确保不同的接口调用请求到对应的 Netty 服务上。PS：如果对应错误或者为启动，可能会发生类似B站事故。
- `第四块`：责任链下插件模块的调用，鉴权、授信、熔断、降级、限流、切量等，这些服务虽然不算是网关的定义下的内容，但作为共性通用的服务，它们通常也是被放到网关层统一设计实现和使用的。
- `第五块`：管理后台，作为一个网关项目少不了一个与之对应的管理后台，用户接口的注册维护、mock测试、日志查询、流量整形、网关管理等服务。



**我们整个微服务模块结构如下：**

| 序号 |      系统      |                             描述                             |
| :--: | :------------: | :----------------------------------------------------------: |
|  1   |  gateway-core  | 网关核心系统：用于网络通信转换处理，承接http请求，调用RPC服务，责任链模块调用 |
|  2   | gateway-admin  |     网关管理系统：用于网关接口后台管理，注册下线停用控制     |
|  3   |  gateway-sdk   |     网关注册组件：用于注解方式采集接口，发送消息注册接口     |
|  4   | gateway-center |     网关注册中心：提供网关注册中心服务，登记网关接口信息     |
|  5   | gateway-assist | 网关服务中心：通信服务组件封装，用于包装gateway-core，通信服务组件封装，让springboot更加容易使用 |
|  6   | gateway-engine |         网关引擎工程：将网关打包成jar放到容器中运行          |



**可以思考改进重构的点：**

1. 协议的解析和转换，Netty 怎么处理的这部分。PS：你们是啥什么技术栈实现？ 

2. 服务治理；熔断、降级、限流、黑白名单等控制，这部分也可以参考下 istio 服务网格化 
2. 并发体量；能支持好多大的体量，怎么设计支持的，是否可以横向扩展。有哪些路由手段。
2. 安全管理；鉴权、风控、浏览器指纹等，以及使用 SPI 机制进行扩展，同时支持业务使用方的 Plugin 插件扩展。
2. 流量监控；嵌入一些监控埋点，与全链路监控打通，Dapper、Pinpoint、Prometheus(普罗米修斯)等等



**我们为什么要重新设计一个网关而不是使用网上开源的API网关：**

像京东、阿里、美团都是有自己的API网关的，因为这样可以更好的控制网关和自身系统的结合，也可以添加各类自己需要的功能，以及支撑更大的流量。但网关这块的维护成本也不低，需要较大的团队来维护迭代。
